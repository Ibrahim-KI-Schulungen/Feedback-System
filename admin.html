<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard | KI Schulungen Feedback</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f8fafc;
      min-height: 100vh;
    }

    /* Login Screen */
    .login-screen {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(145deg, #e8f4fc 0%, #f8fafc 100%);
      padding: 20px;
    }

    .login-card {
      background: #fff;
      border-radius: 20px;
      padding: 48px 40px;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 8px 40px rgba(19, 136, 198, 0.1);
    }

    .login-card h1 {
      font-size: 24px;
      color: #0a5a8a;
      margin-bottom: 8px;
      text-align: center;
    }

    .login-card p {
      color: #6b7280;
      text-align: center;
      margin-bottom: 32px;
      font-size: 14px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #374151;
      margin-bottom: 8px;
    }

    .form-group input {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      font-size: 15px;
      transition: border-color 0.15s;
      outline: none;
    }

    .form-group input:focus {
      border-color: #1388C6;
    }

    .login-btn {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, #1388C6 0%, #0a5a8a 100%);
      color: #fff;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      margin-top: 8px;
    }

    .login-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(19, 136, 198, 0.3);
    }

    .login-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .login-error {
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #dc2626;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 14px;
      margin-bottom: 20px;
      display: none;
    }

    .login-error.show {
      display: block;
    }

    /* Dashboard */
    .dashboard {
      display: none;
    }

    .dashboard.show {
      display: block;
    }

    /* Header */
    .header {
      background: linear-gradient(135deg, #1388C6 0%, #0a5a8a 100%);
      padding: 20px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header h1 {
      color: #fff;
      font-size: 20px;
      font-weight: 600;
    }

    .header-badge {
      background: rgba(255,255,255,0.2);
      color: #fff;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }

    .logout-btn {
      background: rgba(255,255,255,0.15);
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.15s;
    }

    .logout-btn:hover {
      background: rgba(255,255,255,0.25);
    }

    /* Stats Bar */
    .stats-bar {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      padding: 24px;
      background: #fff;
      border-bottom: 1px solid #e5e7eb;
    }

    .stat-card {
      padding: 20px;
      background: #f8fafc;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
    }

    .stat-card .label {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 6px;
    }

    .stat-card .value {
      font-size: 28px;
      font-weight: 700;
      color: #0a5a8a;
    }

    .stat-card .sub {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 4px;
    }

    /* Filters */
    .filters {
      display: flex;
      gap: 12px;
      padding: 20px 24px;
      background: #fff;
      border-bottom: 1px solid #e5e7eb;
      flex-wrap: wrap;
      align-items: center;
    }

    .filter-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .filter-group label {
      font-size: 13px;
      color: #6b7280;
      font-weight: 500;
    }

    .filter-group select {
      padding: 10px 14px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      background: #fff;
      cursor: pointer;
      outline: none;
    }

    .filter-group select:focus {
      border-color: #1388C6;
    }

    .export-btn {
      margin-left: auto;
      padding: 10px 20px;
      background: #10b981;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.15s;
    }

    .export-btn:hover {
      background: #059669;
    }

    /* Content */
    .content {
      padding: 24px;
    }

    /* Schulungen Table */
    .table-container {
      background: #fff;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      overflow: hidden;
    }

    .table-header {
      display: grid;
      grid-template-columns: 100px 1fr 150px 100px 80px 100px;
      padding: 14px 20px;
      background: #f8fafc;
      border-bottom: 2px solid #e5e7eb;
      font-size: 12px;
      font-weight: 600;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .table-row {
      display: grid;
      grid-template-columns: 100px 1fr 150px 100px 80px 100px;
      padding: 16px 20px;
      border-bottom: 1px solid #f3f4f6;
      align-items: center;
      cursor: pointer;
      transition: background 0.1s;
    }

    .table-row:hover {
      background: #f8fafc;
    }

    .table-row:last-child {
      border-bottom: none;
    }

    .table-row .datum {
      font-weight: 500;
      color: #374151;
    }

    .table-row .name {
      font-weight: 500;
      color: #1f2937;
    }

    .table-row .trainer {
      color: #6b7280;
      font-size: 14px;
    }

    .table-row .feedbacks {
      font-weight: 600;
      color: #1388C6;
    }

    .table-row .rating {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .table-row .rating .stars {
      color: #fbbf24;
    }

    .table-row .rating .num {
      font-weight: 600;
      color: #374151;
    }

    .status-badge {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }

    .status-badge.aktiv {
      background: #dcfce7;
      color: #166534;
    }

    .status-badge.abgelaufen {
      background: #fef3c7;
      color: #92400e;
    }

    .status-badge.abgeschlossen {
      background: #f3f4f6;
      color: #6b7280;
    }

    /* Detail Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      z-index: 1000;
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal {
      background: #fff;
      border-radius: 16px;
      width: 100%;
      max-width: 800px;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      padding: 24px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }

    .modal-header h2 {
      font-size: 20px;
      color: #1f2937;
      margin-bottom: 4px;
    }

    .modal-header .meta {
      font-size: 14px;
      color: #6b7280;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      color: #9ca3af;
      cursor: pointer;
      padding: 4px;
    }

    .modal-close:hover {
      color: #6b7280;
    }

    .modal-body {
      padding: 24px;
      overflow-y: auto;
      flex: 1;
    }

    .modal-stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    .modal-stat {
      text-align: center;
      padding: 16px;
      background: #f8fafc;
      border-radius: 10px;
    }

    .modal-stat .value {
      font-size: 24px;
      font-weight: 700;
      color: #0a5a8a;
    }

    .modal-stat .label {
      font-size: 12px;
      color: #6b7280;
      margin-top: 4px;
    }

    .feedback-list h3 {
      font-size: 16px;
      color: #374151;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 2px solid #e8f4fc;
    }

    .feedback-item {
      padding: 16px;
      background: #f8fafc;
      border-radius: 10px;
      margin-bottom: 12px;
    }

    .feedback-item:last-child {
      margin-bottom: 0;
    }

    .feedback-item .header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .feedback-item .date {
      font-size: 13px;
      color: #6b7280;
    }

    .feedback-item .rating-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }

    .mini-rating {
      background: #fff;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 12px;
      border: 1px solid #e5e7eb;
    }

    .mini-rating .label {
      color: #6b7280;
    }

    .mini-rating .value {
      font-weight: 600;
      color: #1388C6;
      margin-left: 4px;
    }

    .feedback-item .comment {
      font-size: 14px;
      color: #4b5563;
      line-height: 1.6;
      padding: 12px;
      background: #fff;
      border-radius: 8px;
      border-left: 3px solid #1388C6;
    }

    .feedback-item .comment-label {
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 6px;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #6b7280;
    }

    .empty-state .icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    /* Loading */
    .loading {
      text-align: center;
      padding: 40px;
      color: #6b7280;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .table-header,
      .table-row {
        grid-template-columns: 1fr;
        gap: 8px;
      }

      .table-header {
        display: none;
      }

      .table-row {
        padding: 16px;
      }

      .modal-stats {
        grid-template-columns: repeat(2, 1fr);
      }

      .filters {
        flex-direction: column;
        align-items: stretch;
      }

      .export-btn {
        margin-left: 0;
        margin-top: 8px;
      }
    }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div class="login-screen" id="loginScreen">
    <div class="login-card">
      <h1>Admin Login</h1>
      <p>KI Schulungen Feedback-System</p>
      
      <div class="login-error" id="loginError"></div>
      
      <form id="loginForm">
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="loginEmail" required placeholder="admin@kischulungen.com">
        </div>
        <div class="form-group">
          <label>Passwort</label>
          <input type="password" id="loginPassword" required placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
        </div>
        <button type="submit" class="login-btn" id="loginBtn">Anmelden</button>
      </form>
    </div>
  </div>

  <!-- Dashboard -->
  <div class="dashboard" id="dashboard">
    <!-- Header -->
    <header class="header">
      <div class="header-left">
        <h1>Feedback Dashboard</h1>
        <span class="header-badge">KI Schulungen</span>
      </div>
      <button class="logout-btn" id="logoutBtn">Abmelden</button>
    </header>

    <!-- Stats -->
    <div class="stats-bar" id="statsBar">
      <div class="stat-card">
        <div class="label">Schulungen gesamt</div>
        <div class="value" id="statTotal">-</div>
      </div>
      <div class="stat-card">
        <div class="label">Feedbacks erhalten</div>
        <div class="value" id="statFeedbacks">-</div>
      </div>
      <div class="stat-card">
        <div class="label">Ã˜ Bewertung</div>
        <div class="value" id="statRating">-</div>
      </div>
      <div class="stat-card">
        <div class="label">Weiterempfehlung</div>
        <div class="value" id="statRecommend">-</div>
      </div>
    </div>

    <!-- Filters -->
    <div class="filters">
      <div class="filter-group">
        <label>Trainer:</label>
        <select id="filterTrainer">
          <option value="">Alle</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Monat:</label>
        <select id="filterMonth">
          <option value="">Alle</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Status:</label>
        <select id="filterStatus">
          <option value="">Alle</option>
          <option value="aktiv">Aktiv</option>
          <option value="abgelaufen">Abgelaufen</option>
          <option value="abgeschlossen">Abgeschlossen</option>
        </select>
      </div>
      <button class="export-btn" id="exportBtn">CSV Export</button>
    </div>

    <!-- Content -->
    <div class="content">
      <div class="table-container">
        <div class="table-header">
          <div>Datum</div>
          <div>Schulung</div>
          <div>Trainer</div>
          <div>Feedbacks</div>
          <div>Ã˜ Note</div>
          <div>Status</div>
        </div>
        <div id="schulungenList">
          <div class="loading">Lade Daten...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Detail Modal -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal">
      <div class="modal-header">
        <div>
          <h2 id="modalTitle">Schulung Details</h2>
          <div class="meta" id="modalMeta"></div>
        </div>
        <button class="modal-close" id="modalClose">&times;</button>
      </div>
      <div class="modal-body">
        <div class="modal-stats" id="modalStats"></div>
        <div class="feedback-list" id="feedbackList">
          <h3>Einzelne Feedbacks</h3>
          <div id="feedbackItems"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // KONFIGURATION
    // ============================================
    const SUPABASE_URL = 'https://nzeqfkiaidskutgkpwcv.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im56ZXFma2lhaWRza3V0Z2twd2N2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1ODA1MzksImV4cCI6MjA4NDE1NjUzOX0.pJgQFGGkyE9atCZbMbwo2-KvuCPV8PRbtjf8KHU1BNY';

    let accessToken = null;
    let schulungen = [];
    let feedbacks = [];
    let trainer = [];

    // ============================================
    // SUPABASE HELPER
    // ============================================
    async function supabaseRequest(endpoint, options = {}) {
      const headers = {
        'apikey': SUPABASE_KEY,
        'Content-Type': 'application/json',
        ...options.headers
      };
      
      if (accessToken) {
        headers['Authorization'] = `Bearer ${accessToken}`;
      }

      const response = await fetch(`${SUPABASE_URL}${endpoint}`, {
        ...options,
        headers
      });

      if (!response.ok) {
        const error = await response.text();
        throw new Error(error);
      }

      const text = await response.text();
      return text ? JSON.parse(text) : null;
    }

    // ============================================
    // AUTH
    // ============================================
    async function login(email, password) {
      const response = await fetch(`${SUPABASE_URL}/auth/v1/token?grant_type=password`, {
        method: 'POST',
        headers: {
          'apikey': SUPABASE_KEY,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ email, password })
      });

      if (!response.ok) {
        throw new Error('Login fehlgeschlagen');
      }

      const data = await response.json();
      accessToken = data.access_token;
      localStorage.setItem('sb_token', accessToken);
      return data;
    }

    function logout() {
      accessToken = null;
      localStorage.removeItem('sb_token');
      showLogin();
    }

    function checkAuth() {
      const token = localStorage.getItem('sb_token');
      if (token) {
        accessToken = token;
        showDashboard();
        loadData();
      }
    }

    // ============================================
    // UI
    // ============================================
    function showLogin() {
      document.getElementById('loginScreen').style.display = 'flex';
      document.getElementById('dashboard').classList.remove('show');
    }

    function showDashboard() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('dashboard').classList.add('show');
    }

    function showError(message) {
      const errorEl = document.getElementById('loginError');
      errorEl.textContent = message;
      errorEl.classList.add('show');
    }

    // ============================================
    // DATA LOADING
    // ============================================
    async function loadData() {
      try {
        // Trainer laden
        trainer = await supabaseRequest('/rest/v1/trainer?select=id,name');
        
        // Schulungen laden
        schulungen = await supabaseRequest('/rest/v1/schulungen?select=*,trainer:trainer_id(name)&order=datum.desc');
        
        // Feedbacks laden
        feedbacks = await supabaseRequest('/rest/v1/feedback?select=*');

        updateFilters();
        updateStats();
        renderSchulungen();
      } catch (error) {
        console.error('Fehler beim Laden:', error);
        if (error.message.includes('JWT')) {
          logout();
        }
      }
    }

    function updateFilters() {
      // Trainer Filter
      const trainerSelect = document.getElementById('filterTrainer');
      trainerSelect.innerHTML = '<option value="">Alle</option>';
      trainer.forEach(t => {
        trainerSelect.innerHTML += `<option value="${t.id}">${t.name}</option>`;
      });

      // Monat Filter
      const months = [...new Set(schulungen.map(s => s.datum.substring(0, 7)))].sort().reverse();
      const monthSelect = document.getElementById('filterMonth');
      monthSelect.innerHTML = '<option value="">Alle</option>';
      months.forEach(m => {
        const [year, month] = m.split('-');
        const monthNames = ['Jan', 'Feb', 'MÃ¤r', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dez'];
        monthSelect.innerHTML += `<option value="${m}">${monthNames[parseInt(month)-1]} ${year}</option>`;
      });
    }

    function updateStats() {
      document.getElementById('statTotal').textContent = schulungen.length;
      document.getElementById('statFeedbacks').textContent = feedbacks.length;

      // Durchschnittliche Bewertung
      if (feedbacks.length > 0) {
        const avgRating = feedbacks.reduce((sum, f) => sum + (f.frage1 || 0), 0) / feedbacks.length;
        document.getElementById('statRating').textContent = avgRating.toFixed(1);

        // Weiterempfehlung
        const recommends = feedbacks.filter(f => f.frage11 === true).length;
        const percentage = Math.round((recommends / feedbacks.length) * 100);
        document.getElementById('statRecommend').textContent = `${percentage}%`;
      } else {
        document.getElementById('statRating').textContent = '-';
        document.getElementById('statRecommend').textContent = '-';
      }
    }

    function getStatus(schulung) {
      if (schulung.status === 'abgeschlossen') return 'abgeschlossen';
      
      const now = new Date();
      const schulungDate = new Date(schulung.datum);
      const expiresAt = new Date(schulungDate);
      expiresAt.setDate(expiresAt.getDate() + 1);
      expiresAt.setHours(18, 0, 0, 0);

      if (now > expiresAt) return 'abgelaufen';
      return 'aktiv';
    }

    function renderSchulungen() {
      const container = document.getElementById('schulungenList');
      
      // Filter anwenden
      const trainerFilter = document.getElementById('filterTrainer').value;
      const monthFilter = document.getElementById('filterMonth').value;
      const statusFilter = document.getElementById('filterStatus').value;

      let filtered = schulungen;

      if (trainerFilter) {
        filtered = filtered.filter(s => s.trainer_id == trainerFilter);
      }
      if (monthFilter) {
        filtered = filtered.filter(s => s.datum.startsWith(monthFilter));
      }
      if (statusFilter) {
        filtered = filtered.filter(s => getStatus(s) === statusFilter);
      }

      if (filtered.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="icon">ðŸ“‹</div>
            <div>Keine Schulungen gefunden</div>
          </div>
        `;
        return;
      }

      container.innerHTML = filtered.map(s => {
        const schulungFeedbacks = feedbacks.filter(f => f.schulung_id === s.id);
        const feedbackCount = schulungFeedbacks.length;
        const avgRating = feedbackCount > 0 
          ? (schulungFeedbacks.reduce((sum, f) => sum + (f.frage1 || 0), 0) / feedbackCount).toFixed(1)
          : '-';
        const status = getStatus(s);
        const trainerName = s.trainer?.name || 'Unbekannt';

        return `
          <div class="table-row" onclick="openDetail('${s.id}')">
            <div class="datum">${formatDate(s.datum)}</div>
            <div class="name">${s.name}</div>
            <div class="trainer">${trainerName}</div>
            <div class="feedbacks">${feedbackCount}</div>
            <div class="rating">
              ${avgRating !== '-' ? `<span class="stars">â˜…</span>` : ''}
              <span class="num">${avgRating}</span>
            </div>
            <div><span class="status-badge ${status}">${status}</span></div>
          </div>
        `;
      }).join('');
    }

    function formatDate(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });
    }

    // ============================================
    // DETAIL MODAL
    // ============================================
    function openDetail(schulungId) {
      const schulung = schulungen.find(s => s.id === schulungId);
      if (!schulung) return;

      const schulungFeedbacks = feedbacks.filter(f => f.schulung_id === schulungId);
      
      document.getElementById('modalTitle').textContent = schulung.name;
      document.getElementById('modalMeta').textContent = `${formatDate(schulung.datum)} â€¢ ${schulung.trainer?.name || 'Unbekannt'}`;

      // Stats
      const feedbackCount = schulungFeedbacks.length;
      const avgRating = feedbackCount > 0 
        ? (schulungFeedbacks.reduce((sum, f) => sum + (f.frage1 || 0), 0) / feedbackCount).toFixed(1)
        : '-';
      const avgPraxis = feedbackCount > 0 
        ? (schulungFeedbacks.reduce((sum, f) => sum + (f.frage8 || 0), 0) / feedbackCount).toFixed(1)
        : '-';
      const recommends = feedbackCount > 0
        ? Math.round((schulungFeedbacks.filter(f => f.frage11 === true).length / feedbackCount) * 100)
        : 0;

      document.getElementById('modalStats').innerHTML = `
        <div class="modal-stat">
          <div class="value">${feedbackCount}</div>
          <div class="label">Feedbacks</div>
        </div>
        <div class="modal-stat">
          <div class="value">${avgRating}</div>
          <div class="label">Ã˜ Gesamt</div>
        </div>
        <div class="modal-stat">
          <div class="value">${avgPraxis}</div>
          <div class="label">Ã˜ Praxisnutzen</div>
        </div>
        <div class="modal-stat">
          <div class="value">${recommends}%</div>
          <div class="label">Empfehlung</div>
        </div>
      `;

      // Feedbacks
      const feedbackItems = document.getElementById('feedbackItems');
      if (schulungFeedbacks.length === 0) {
        feedbackItems.innerHTML = '<div class="empty-state">Noch keine Feedbacks</div>';
      } else {
        feedbackItems.innerHTML = schulungFeedbacks.map(f => `
          <div class="feedback-item">
            <div class="header">
              <div class="rating-row">
                <div class="mini-rating"><span class="label">Gesamt:</span><span class="value">${f.frage1}/5</span></div>
                <div class="mini-rating"><span class="label">Trainer:</span><span class="value">${f.frage2}/5</span></div>
                <div class="mini-rating"><span class="label">Didaktik:</span><span class="value">${f.frage3}/5</span></div>
                <div class="mini-rating"><span class="label">Praxis:</span><span class="value">${f.frage8}/5</span></div>
              </div>
              <div class="date">${new Date(f.created_at).toLocaleDateString('de-DE')}</div>
            </div>
            ${f.frage7 ? `<div class="comment"><div class="comment-label">Was hat gefallen:</div>${f.frage7}</div>` : ''}
            ${f.frage10 ? `<div class="comment" style="margin-top:8px;border-left-color:#f59e0b"><div class="comment-label">VerbesserungsvorschlÃ¤ge:</div>${f.frage10}</div>` : ''}
            ${f.frage12 ? `<div class="comment" style="margin-top:8px;border-left-color:#8b5cf6"><div class="comment-label">PersÃ¶nliches Feedback:</div>${f.frage12}</div>` : ''}
          </div>
        `).join('');
      }

      document.getElementById('modalOverlay').classList.add('show');
    }

    function closeModal() {
      document.getElementById('modalOverlay').classList.remove('show');
    }

    // ============================================
    // EXPORT
    // ============================================
    function exportCSV() {
      const headers = ['Datum', 'Schulung', 'Trainer', 'Gesamt', 'Trainer-Bewertung', 'Didaktik', 'Praxisnutzen', 'Was hat gefallen', 'Verbesserungen', 'Weiterempfehlung'];
      
      const rows = feedbacks.map(f => {
        const schulung = schulungen.find(s => s.id === f.schulung_id);
        return [
          f.created_at ? new Date(f.created_at).toLocaleDateString('de-DE') : '',
          schulung?.name || '',
          schulung?.trainer?.name || '',
          f.frage1 || '',
          f.frage2 || '',
          f.frage3 || '',
          f.frage8 || '',
          `"${(f.frage7 || '').replace(/"/g, '""')}"`,
          `"${(f.frage10 || '').replace(/"/g, '""')}"`,
          f.frage11 ? 'Ja' : 'Nein'
        ].join(';');
      });

      const csv = [headers.join(';'), ...rows].join('\n');
      const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = `feedbacks_export_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // ============================================
    // EVENT LISTENERS
    // ============================================
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = document.getElementById('loginBtn');
      btn.disabled = true;
      btn.textContent = 'Anmelden...';

      try {
        await login(
          document.getElementById('loginEmail').value,
          document.getElementById('loginPassword').value
        );
        showDashboard();
        loadData();
      } catch (error) {
        showError('Login fehlgeschlagen. Bitte prÃ¼fen Sie Ihre Zugangsdaten.');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Anmelden';
      }
    });

    document.getElementById('logoutBtn').addEventListener('click', logout);
    document.getElementById('modalClose').addEventListener('click', closeModal);
    document.getElementById('modalOverlay').addEventListener('click', (e) => {
      if (e.target === document.getElementById('modalOverlay')) closeModal();
    });
    document.getElementById('exportBtn').addEventListener('click', exportCSV);

    // Filter Events
    document.getElementById('filterTrainer').addEventListener('change', renderSchulungen);
    document.getElementById('filterMonth').addEventListener('change', renderSchulungen);
    document.getElementById('filterStatus').addEventListener('change', renderSchulungen);

    // Init
    checkAuth();
  </script>
</body>
</html>
